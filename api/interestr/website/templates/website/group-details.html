{% extends 'website/base.html' %}

{% load static %}

{% block title %}Create a new Group{% endblock title %}

{% block navbaritems %}
<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
  <ul class="nav navbar-nav navbar-right">
    <li class="nav-search">
      <input type="text" value="" class="form-control" placeholder="Search...">
    </li>
    <li>
      <a href="javascript:void(0);">
        <i class="fa fa-search"></i>
      </a>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ user.username }}<b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li><a href="{% url 'website:news' %}">News Feed</a></li>
        <li><a href="{% url 'website:groups' %}">Groups</a></li>
        <li class="divider"></li>
        <li><a href="{% url 'website:logout' %}">Logout</a></li>
      </ul>
    </li>
  </ul>
</div>
{% endblock navbaritems %}

{% block content %}
<div class="main">
  <div class="container">
    <div class="col-md-3">
      <div class="row left-nav-block">
        <h5>YOUR GROUPS</h5>
        <div class="btn btn-round btn-left-nav">
          <span>Guitar Freaks</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <span>Metal Music</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <strong>+ Create More Groups</strong>
        </div>


      </div>

      <div class="row left-nav-block">
        <h5>JOINED GROUPS</h5>

        <div class="btn btn-round btn-left-nav">
          <span>Guitar Freaks</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <span>Metal Music</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <span>Guitar Hero</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <span>Video Games</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <span>Alter Bridge Fans</span><span>...</span>
        </div>

        <div class="btn btn-round btn-left-nav">
          <strong>+ Join More Groups</strong>
        </div>
      </div>
    </div>

    <div class="col-md-9 main-block">
      <div class="group-detail-header-block">
        <div class="group">
          <div class="group-image">
            <img src="{{ group.get_picture }}" alt="Group alt..." class="img-thumbnail img-responsive">
          </div>
          <div class="group-info">
            <div class="group-name">
              <h4>{{ group.name }}</h4>
            </div>
            <div class="group-member-count">
              {{ group.size }} member{{ group.size|pluralize }}
            </div>
            <div class="group-description">
              {{ group.description }}
            </div>
          </div>
        </div>

        <div class="buttons">
          <div id="leaveJoinButton" class="btn btn-round btn-fill" onclick="leave_join_group()"></div>
          <div class="btn btn-round">More ...</div>

          <script type="text/javascript">
            var isJoined = {{ is_joined|yesno:"1,0" }};
            var buttonText = ['Join Group', 'Leave Group'];
            var buttonTextPending = ['Joining...', 'Leaving...'];
            var btn = document.getElementById('leaveJoinButton');

            function refresh_button() {
              btn.textContent = buttonText[isJoined];
              if (!isJoined) {
                btn.classList.add("btn-warning");
              }
              else {
                btn.classList.remove("btn-warning");
              }
              btn.disabled = false;
            }

            refresh_button();

            function leave_join_group() {
              if (!btn.disabled) {
                btn.disabled = true;
                btn.textContent = buttonTextPending[isJoined];

                $.ajax({
                  method: isJoined ? 'DELETE' : 'PUT',
                  url: '{% url "api:groupOperation" group.id %}'
                }).done(function (msg) {
                  isJoined = 1 - isJoined;
                  refresh_button();
                });
              }
            }
          </script>
        </div>
      </div>

      <div class="group-detail-content-create-block">
        <select id="templateSelection" class="custom-select">
          <option selected>Default</option>
          {% for template in group.data_templates.all %}
            <option value="{{ template.id }}">{{ template.name }}</option>
          {% endfor %}
        </select>       

        <button class="btn btn-primary btn-round dropdown-toggle" type="button" data-toggle="modal" data-target="#createTemplateModal">Create New</button>
        <button class="btn btn-success btn-round dropdown-toggle" type="button" data-toggle="modal" data-target="#createTemplateModal">Extend This</button>
        <button class="btn btn-danger btn-round dropdown-toggle" type="button" data-toggle="modal" data-target="#createTemplateModal">Edit This</button>

        <form method="POST" class="group-detail-content-form">
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div id="formFields" class="form-group">
            <label for="name">Text: </label>
            <input type="text" class="form-control" id="text" name="{{ post_create_form.text.name }}" placeholder="Text of the post">
            {{ form.text.errors }}
          </div>

          <div class="text-right">
            <button type="submit" class="btn btn-round btn-warning btn-fill btn-wide">Share</button>
          </div>
        </form>
      </div>

      {% for post in group.posts.all %}
      <div class="group-detail-content">
        <div class="header">
          <div class="text">
            <p class="title"><strong>{{ post.owner.username }}</strong></p>
            <p class="subtitle"><small>Shared in <i>{{ group.name }}</i></small></p>
          </div>
          <div class="img">
            <img src="{% static 'assets/img/user.jpg' %}" alt="User placeholder" class="img-circle avatar">
          </div>
        </div>
        <div class="content">
          <p>{{ post.text }}</p>
        </div>
        <div class="comments">
          <a class="text-muted" href="#">0 Comments</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="createTemplateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Create a template</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group row">
              <label for="templateName" class="col-sm-2 col-form-label">Name</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="templateName" value="">
              </div>
            </div>
            <div id="templateFields"></div>
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" id="newFieldDropdownButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                +
              </button>
              <div class="dropdown-menu" id="newFieldDropdown" aria-labelledby="newFieldDropdownButton"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Dismiss</button>
          <button id="templateSubmitButton" type="button" class="btn btn-primary">Create!</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var fields;
    var templateFieldTypes;
    var dropdownItem;
    var dropdown;
    var removeButton;
    var removeSymbol;
    var editTextInput;
    var editTextInputInitial;
    var modal;
    var submitButton;
    var templateName;
    var templateSelection;

    modal = document.getElementById('createTemplateModal');
    fields = document.getElementById('templateFields');
    submitButton = document.getElementById('templateSubmitButton');
    templateName = document.getElementById('templateName');
    templateSelection = document.getElementById('templateSelection');

    function type2Input(type) {
      var el;

      if (type == 'textarea') {
        el = document.createElement('textarea');
      }
      else {
        el = document.createElement('input');
        el.type = type;
      }

      return el;
    }

    function input2type(input) {
      return input.tagName == 'TEXTAREA' ? 'textarea' : input.type;
    }

    function replaceInputWithSpan() {
      if (editTextInput) {
        var span = makeChangableSpan(editTextInput.value || editTextInputInitial);
        editTextInput.parentNode.replaceChild(span, editTextInput);

        editTextInput = null;

        modal.focus();
      }
    }

    modal.onclick = function (event) {
      if (event.target != editTextInput) {
        replaceInputWithSpan();
      }
    };

    function replaceSpanWithInput(span) {
      replaceInputWithSpan();

      editTextInputInitial = span.textContent;

      editTextInput = document.createElement('input');
      editTextInput.type = 'text';
      editTextInput.value = editTextInputInitial;

      editTextInput.onkeypress = function (event) {
        if (event.key == 'Enter') replaceInputWithSpan(editTextInput);
      };

      span.parentNode.replaceChild(editTextInput, span);
      editTextInput.focus();
      editTextInput.select();
    }

    function makeChangableSpan(str, editable = true) {
      var span = document.createElement('span');
      span.textContent = str;

      if (editable) {
        span.onclick = function (event) {
          replaceSpanWithInput(span);
          event.stopPropagation();
        };
        // span.onkeydown = function (event) {
        //   if (event.key == 'Enter') replaceInputWithSpan(span);
        // }
        span.tabIndex = '1';
      }

      return span;
    }

    function createTemplateField(editable, type, inputs, legend = 'Field legend') {
      var input;
      var label;
      var inputElemCount;
      
      var fieldElem;
      var legendElem;
      var inputElem;
      var labelElem;
      var text;
      var inputContainer;

      fieldElem = document.createElement('div');
      fieldElem.classList.add('form-group', 'row');
      fieldElem.attributes['data-template-type'] = type;

      legendElem = document.createElement('label');
      legendElem.classList.add('col-form-legend', 'col-sm-2');
      legendElem.appendChild(makeChangableSpan(legend, editable));
      fieldElem.appendChild(legendElem);

      inputElemCount = 0;

      inputContainer = document.createElement('div');
      for (input of inputs) {
        inputElem = type2Input(input.type);

        if (input.label) {
          labelElem = document.createElement('label');
          labelElem.appendChild(inputElem);
        
          text = makeChangableSpan(input.label, editable);
          if (input.side == 'R') {
            labelElem.appendChild(text);
          }
          else if (input.side == 'L') {
            labelElem.insertBefore(text, inputElem);
          }

          inputContainer.appendChild(labelElem);
        }
        else {
          inputContainer.appendChild(inputElem);
        }

        inputElemCount++;
      }
      fieldElem.appendChild(inputContainer);

      function uniqueID() {
        var id = '_' + Math.random().toString(36).substr(2, 9);

        return document.getElementById(id) == null ? id : uniqueID();
      }

      if (inputElemCount == 1) {
        (/*labelElem || */inputElem).id = legendElem.htmlFor = uniqueID();
      }

      // Following are for the removal button
      if (editable) {
        removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.classList.add('close');
        removeButton.attributes['data-dismiss'] = 'modal';
        removeButton.attributes['aria-label'] = 'Remove';

        removeSymbol = document.createElement('span');
        removeSymbol.attributes['aria-hidden'] = 'true';
        removeSymbol.innerHTML = '&times;';

        removeButton.appendChild(removeSymbol);
        removeButton.onclick = function (event) {
          fieldElem.remove();
        }

        fieldElem.appendChild(removeButton);
      }

      return fieldElem;
    }

    function createCheckboxField(legend = 'A question?', label = 'Agree') {
      return createTemplateField(true, this.type,
        [
          {
            type: 'checkbox',
            label: label,
            side: 'R'
          }
        ],
        legend);
    }

    function createMultiselField(legend = 'There are...', labels = ['Birds', 'Trees', 'Fountains']) {
      return createTemplateField(true, this.type,
        labels.map(
          label =>
          {
            return {
              type: 'checkbox',
              label: label,
              side: 'R'
            };
          }
        ),
        legend);
    }

    function createTextareaField(legend = 'Your feedback') {
      return createTemplateField(true, this.type,
        [
          {
            type: 'textarea',
            label: false
          }
        ],
        legend);
    }

    templateFieldTypes = {};

    function registerTemplateField(type, creator, friendlyName) {
      templateFieldTypes[type] = {
        friendlyName: friendlyName,
        creator: creator
      };

      creator.type = type;
    }

    registerTemplateField('checkbox', createCheckboxField, 'Checkbox');
    registerTemplateField('multisel', createMultiselField, 'Multiple Selection');
    registerTemplateField('textarea', createTextareaField, 'Text Area');

    dropdown = document.getElementById('newFieldDropdown')

    for (const type in templateFieldTypes) {
      dropdownItem = document.createElement('button');
      dropdownItem.classList.add('dropdown-item');
      dropdownItem.type = 'button';

      dropdownItem.textContent = templateFieldTypes[type].friendlyName;
      dropdownItem.onclick = function (event) {
        var field = templateFieldTypes[type].creator();
        fields.appendChild(field);
        field.firstChild.firstChild.focus();
      }

      dropdown.appendChild(dropdownItem);
    }

    function toJSON() {
      var field;
      var fieldObject;
      var fieldElem;
      var templateObject;
      var i, j;
      var input;
      var labelIndex;

      templateObject = {
        name: templateName.value,
        group: '{{ group.id }}',
        user: '{{ user.id }}',
        fields: []
      };

      for (field of fields.childNodes) {
        fieldObject = {
          type: field.attributes['data-template-type'],
          legend: field.childNodes[0].textContent,
          inputs: []
        };

        for (fieldElem of field.childNodes[1].childNodes) {
          if (fieldElem.tagName == 'LABEL') {
            labelIndex = (fieldElem.childNodes[1] == 'SPAN') * 1;

            input = {
              type: input2type(fieldElem.childNodes[1 - labelIndex]),
              label: fieldElem.childNodes[labelIndex].textContent,
              side: labelIndex == 0 ? 'L' : 'R',
            };
          }
          else {
            input = {
              type: input2type(fieldElem),
              label: false
            };
          }

          fieldObject.inputs.push(input);
        }

        templateObject.fields.push(fieldObject);
      }
      
      return templateObject;
    }

    function fromJSON(templateObject) {
      
    }

    submitButton.onclick = function (event) {
      var data;

      if (!submitButton.disabled) {
        submitButton.disabled = true;

        replaceInputWithSpan();
        data = toJSON();
        data.csrfmiddlewaretoken = '{{ csrf_token }}';
        data.fields = JSON.stringify(data.fields);

        $.ajax({
          method: 'POST',
          url: '{% url "api:datatemplates" %}',
          data: data
        }).done(function (msg) {
          location.reload();
        }).fail(function (msg) {
          alert(msg.responseText);
        }).always(function (msg) {
          submitButton.disabled = false;
        });
      }
    }

    function updateTemplate() {
      var templateID = templateSelection.value;
      $.ajax({
        method: 'GET',
        url: '{% url "api:datatemplatedetail" 12345 %}'.replace(/12345/, templateID.toString())
      }).done(function (templateData) {
        var formFields;
        var field;

        if (templateData.group == {{ group.id }}) {
          formFields = document.getElementById('formFields');
          
          while (formFields.firstChild) {
            formFields.removeChild(formFields.firstChild);
          }

          for (field of templateData.fields) {
            formFields.appendChild(createTemplateField(false, field.type, field.inputs, field.legend));
          }
        }
      });
    }

    templateSelection.onchange = updateTemplate;

    /*

<button class="dropdown-item" type="button">Action</button>

checkbox        checkbox
                multiple-selection
color           color-pick
date            date-pick
datetime-local  datetime-pick

email     
file      
hidden      
image     
month     
number      
password    
Note      
radio     
range     
reset     
search      
submit      
tel       
text      
time      
url       
week      

    */


  </script>

{% endblock content %}
